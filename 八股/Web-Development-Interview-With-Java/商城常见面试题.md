# 商城常见面试题

## 0、详细讲一下你的项目？

项目基于多个微服务模块实现，使用 Nacos 做为微服务的注册与发现中心。引入 gateway 组件作为服务入口的统一管理。使用 Open Feign 作为服务间通信的组件，基于请求与响应的方式。使用 seata 组件提供分布式事务的服务。基于 ES 实现商品的检索等等。

## 1、你项目中的难点是什么？（字节）（华为）（美团）

### 一、查询商品详情

查询**商品详情**，也就是从商城主页面点击一个商品到展示一个商品的详细信息这一步骤。由于逻辑比较复杂，而且有些数据还需要进行远程调用。

**（获取 SKU 基本信息 -> 获取 SKU 图片信息 -> 获取 SKU 促销信息 -> 获取 SPU 销售属性 -> 获取规格参数组以及组下参数-> 获取 SPU 详情）**为了优化这一部分的时间，引入了线程池技术从而多线程异步的方式执行以上任务。

但是异步任务又涉及到一个**异步编排**的问题，也就是说有些任务的先后顺序是有要求的。可以使用`completableFuture`来完成异步编排。

**二、登录问题**

抽取 SSO 单点登录模块，一切的登录请求由该模块处理。是基于相同顶级域名的 SSO 实现。

## 2、你用了线程池，为什么用线程池？工作顺序说一下？（顺丰科技）（滴滴）（美团）（shopee）

1. 使用线程池可以减少创建和销毁线程的次数，从而降低资源的消耗。每个工作线程都可以重复使用
2. 可以根据系统的承受能力，调整线程池中工作线程的数量，防止因为消耗过多内存导致服务器崩溃

创建线程池之后，**核心线程开始执行任务**，核心线程占用完了，**其他任务进入阻塞队列**，空闲线程开始执行任务。**没有空闲线程了并且队列也满了**，使用拒绝策略拒绝其他任务。

拒绝策略：抛弃老任务策略、丢弃新任务策略、直接抛异常策略等等

## 3、单点登录是什么？（顺丰科技）（shopee）

单点登录英文全称 Single Sign On，简称就是 SSO。它的解释是：**在多个应用系统中，只需要登录一次，就可以访问其他相互信任的应用系统。**

**普通的登录认证机制：**

![](普通登录机制.png)

我们在浏览器（Browser）中访问一个应用，这个应用需要登录，我们填写完用户名和密码后，完成登录认证。这时，我们在这个用户的 session 中标记登录状态为 yes（已登录），同时在浏览器（Browser）中写入 Cookie，这个 Cookie 是这个用户的唯一标识。下次我们再访问这个应用的时候，请求中会带上这个 Cookie，服务端会根据这个 Cookie 找到对应的 session，通过 session 来判断这个用户是否登录。如果不做特殊配置，这个 Cookie 的名字叫做`jsessionid`，值在服务端（server）是唯一的。

**同顶级域名下的单点登录：**

一个企业一般情况下只有一个域名，通过二级域名区分不同的系统。比如我们有个域名叫做：a.com，同时有两个业务系统分别为：app1.a.com 和 app2.a.com。我们要做单点登录（SSO），需要一个登录系统（微服务），叫做：sso.a.com。

**我们只要在 sso.a.com 登录，app1.a.com 和 app2.a.com 就也登录了**。通过上面的登陆认证机制，我们可以知道，在 sso.a.com 中登录了，其实是在 sso.a.com 的服务端的 session 中记录了登录状态，同时在浏览器端（Browser）的 sso.a.com 下写入了 Cookie。那么我们怎么才能让 app1.a.com 和 app2.a.com 登录呢？这里有两个问题：

- Cookie 是不能跨域的，我们 Cookie 的 domain 属性是 sso.a.com，在给 app1.a.com 和 app2.a.com 发送请求是带不上的。
- sso、app1 和 app2 是不同的应用，它们的 session 存在自己的应用内，是不共享的。

![](同域名下单点登录.png)

**解决办法：**针对 cookie 跨域问题，**将 cookie 域设置为顶域**，即属于 a.com。这样所有的子域系统都能访问到顶域的 cookie。针对 session 问题，可以使用**Spring-session** 解决 session 共享问题。

## 3.1、spring session 原理？

spring-session 配合 redis 将 session 进行统一管理。

## 4、为什么需要单点登录？

方便客户、不需要记住多个 ID 和密码。

## 5、cookie 可以跨域名传输吗？（平安科技）

默认不可以，但可以设置。

服务端使用使用`@CrossOrigin`注解时。只需要在网页端设置跨域 `XMLHttpRequest` 请求的 `withCredentials` 属性就可以正常设置和获取跨域 Cookie。

## 6、如何写一个统计页面访问次数业务？（顺丰科技）

## 7、你 Jmeter 压测的什么接口？能达到一个什么样的性能？（美团）

分别压测了动静分离、redis 中间件引入前的商城主页面接口。

## 8、你为什么用 canal？（美团）

解决数据库缓存的一致性问题。另外一种解决方式是采用改完数据库删缓存的方式。

canal 通过模拟 MySQL 的从机，从而完成类似于 MySQL 的主从复制的过程。然后 canal 将从 MySQL 读到的数据同步到 redis、ES 中。

## 9、什么是分布式事务？有什么特点？和单机事务有什么区别？（shopee）（跟谁学）

后面分布式事务中有详细讲解。

## 10、两阶段提交？

2pc，后面分布式事务中有详细讲解。

## 11、线程池的核心线程数有没有经验值？（滴滴）

- 如果是 CPU 密集型应用（CPU 使用率很高，若开过多的线程数，只能增加上下文切换的次数，因此会带来额外的开销。），则线程池核心线程数大小设置为**N+1**
- 如果是 IO 密集型应用（IO 密集型任务 CPU 使用率并不高，因此可以让 CPU 在等待 IO 的时候去处理别的任务，充分利用 CPU 时间。），则线程池核心线程数大小大小设置为**2N+1**

其中 N 为 CPU 的核心数。

## 12、你分布式服务中假设同一功能的微服务部署了多台，你的请求是怎么处理的？（百度）

可以依靠 Open Feign 组件内部封装的 Ribbon 实现提供相同服务的微服务的负载均衡。

```Java
@FeignClient("mall-coupon") // 标识了要去调用的那个微服务
public interface CouponFeignService {
    @PostMapping("/coupon/spubounds/save")
    R saveSpuBounds(@RequestBody SpuBoundTo spuBoundTo);

    @PostMapping("/coupon/skufullreduction/saveinfo")
    R saveSkuReduction(@RequestBody SkuReductionTo skuReductionTo);

}
```

在使用`@FeignClient`注解的时候 是默认使用了 Ribbon 进行客户端的负载均衡的，默认的是随机的策略，那么如果我们想要更改策略的话，需要修改消费者`yml`中的配置，如下：

```yml
ribbon:
	NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略
```

## 13、你的项目还有什么可以扩展的地方？（字节）

加第三方登录（微博、QQ 等）功能。完善 SSO 功能。

## 14、数据库结构设计方面问题？

采用分库分表的方式设置数据库。为每一个微服务设置独立的数据库。

## 15、分布式服务中生成全局唯一 ID 的方式？（招银网络科技）

分布式 ID 的特点：全局唯一性、递增性、高可用性。

常见解决方案：

UUID、**雪花算法**、UidGenerator、Leaf

雪花算法概要：`SnowFlake`是 Twitter 公司采用的一种算法，目的是在分布式系统中产生全局唯一且趋势递增的 ID。`SnowFlake`算法在同一毫秒内最多可以生成多少个全局唯一 ID 呢： **同一毫秒的 ID 数量 = 1024 X 4096 = 4194304**。雪花算法的实现主要依赖于**数据中心 ID 和数据节点 ID**这两个参数。

## 16、分布式、微服务、SOA？（shopee）（美团）

微服务的特点：技术异构性、隔离性、可扩展性、易于优化性。

## 17、购物车模块用户登录与没有登录分别如何使用购物车功能？（shopee）

1. 用户没有登录时，我们将用户的购物车信息存储在 cookie 中。但是此时用户登录了在其他电脑上就会看不到当前购物车的信息。
2. 用户登录后，将用户的 cookie 中的信息存储到 redis 中保存，这样的话同一账号下都可以使用同一个购物车的信息。

## 18、如果用户一直添加购物车添加商品怎么办？并且他添加一次你查询一次数据库？互联网上用户那么多，这样会对数据库造成很大压力你怎么办？（shopee）

用户往购物车中添加商品并不会直接操作数据库，而是通过操作 redis 或者 cookie 然后最终通过 redis 的持久化机制存储到 MySQL 中。所以频繁的添加购物车不会有问题。

## 19、如何实现分页功能？

## 20、如何解决 MySQL 数据库和 ES 数据不一致问题？（美团）（字节）

1. **双写模式：** 我们采取 MySQL 作为主要的数据存储，利用 MySQL 的事务特性维护数据一致性，使用 ElasticSearch 进行数据汇集和查询，此时 es 与数据库的同步方案就尤为重要。

   **保证 es 与数据库的同步方案：**

   1、首先添加商品入数据库，添加商品成功后，商品入 ES，若入 ES 失败，将失败的商品 ID 放入 redis 的缓存队列（或 MQ），且失败的商品 ID 入 log 文件（若出现 redis 挂掉，可从日志中取异常商品 ID 然后再入 ES），
   task 任务每秒刷新一下 redis 缓存队列，若是从缓存队列中取到商品 ID，则根据商品 ID 从数据库中获取商品数据然后入 ES。

2. **canal 组件控制一致性**

## 20.1、如果数据库写失败了怎么办？ES 写失败了怎么办？

若入 ES 失败，将失败的商品 ID 放入 redis 的缓存队列（或 MQ），且失败的商品 ID 入 log 文件（若出现 redis 挂掉，可从日志中取异常商品 ID 然后再入 ES），
task 任务每秒刷新一下 redis 缓存队列，若是从缓存队列中取到商品 ID，则根据商品 ID 从数据库中获取商品数据然后入 ES。
